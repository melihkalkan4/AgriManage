@model AgriManage.Models.DashboardViewModel

@{
    ViewData["Title"] = "Ana Sayfa";
    bool isAdmin = User.IsInRole("Admin");
}

@if (!User.Identity.IsAuthenticated)
{
    <div class="text-center mt-5">
        <div class="p-5 mb-4 bg-light rounded-3 shadow-sm">
            <h1 class="display-4 fw-bold text-success">AgriManage'a Hoş Geldiniz</h1>
            <p class="lead text-muted">Tarla yönetim sistemine giriş yapınız.</p>
            <hr class="my-4">
            <p>Tarlalarınızı kayıt altına alın, lokasyon bazlı analiz yapın.</p>
            <a href="/Identity/Account/Login" class="btn btn-primary btn-lg px-4 gap-3">Giriş Yap</a>
            <a href="/Identity/Account/Register" class="btn btn-outline-secondary btn-lg px-4">Kayıt Ol</a>
        </div>
    </div>
}
else
{
    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-white bg-primary mb-3 shadow border-0" style="background: linear-gradient(45deg, #0d6efd, #0a58ca);">
                    <div class="card-body text-center p-3">
                        <h6 class="card-title text-white-50"><i class="fa-solid fa-wheat-awn"></i> Toplam Tarla</h6>
                        <h2 class="fw-bold">@Model.Tarlalar.Count</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-white bg-success mb-3 shadow border-0" style="background: linear-gradient(45deg, #198754, #146c43);">
                    <div class="card-body text-center p-3">
                        <h6 class="card-title text-white-50"><i class="fa-solid fa-ruler-combined"></i> Toplam Arazi (Dönüm)</h6>
                        <h2 class="fw-bold">@Model.Tarlalar.Sum(t => t.AlanDonum).ToString("0.##")</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-white bg-info mb-3 shadow border-0" style="background: linear-gradient(45deg, #0dcaf0, #0bacbe);">
                    <div class="card-body text-center p-3">
                        <h6 class="card-title text-white-50">
                            @(isAdmin? Html.Raw("<i class='fa-solid fa-users'></i> Aktif Personel") : Html.Raw("<i class='fa-solid fa-clipboard-list'></i> Aktif Görevlerim"))
                        </h6>
                        <h2 class="fw-bold">
                            @(isAdmin? Model.Personeller.Count : Model.AktifGorevSayisi)
                        </h2>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card text-white bg-warning mb-3 shadow border-0" style="background: linear-gradient(45deg, #ffc107, #d39e00);">
                    <div class="card-body text-center p-3">
                        <h6 class="card-title text-white-50"><i class="fa-solid fa-triangle-exclamation"></i> Arızalı Ekipman</h6>
                        <h2 class="fw-bold">@Model.ArizaliEkipmanSayisi</h2>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-md-5">
                <div class="card shadow border-0 h-100">
                    <div class="card-header bg-white py-3">
                        <h5 class="mb-0 text-secondary"><i class="fa-solid fa-chart-pie"></i> Bölgesel Dağılım</h5>
                    </div>
                    <div class="card-body">
                        @if (!Model.Tarlalar.Any())
                        {
                            <div class="text-center py-5 text-muted">Grafik için veri yok.</div>
                        }
                        else
                        {
                            <div style="height: 250px;">
                                <canvas id="bolgeChart"></canvas>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="col-md-7">
                <div class="card shadow border-0 h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between">
                        <h5 class="mb-0 text-secondary"><i class="fa-solid fa-list"></i> Tarlalarım</h5>
                        <a asp-controller="Tarla" asp-action="Index" class="btn btn-sm btn-link p-0">Tümünü Gör</a>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Tarla Adı</th>
                                    <th>Lokasyon</th>
                                    <th>Dönüm</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Tarlalar.Any())
                                {
                                    @foreach (var item in Model.Tarlalar.Take(5))
                                    {
                                        <tr>
                                            <td>@item.Ad</td>
                                            <td>@(item.Lokasyon?.Ad ?? "-")</td>
                                            <td>@item.AlanDonum</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="3" class="text-center text-muted">Kayıtlı tarla bulunmuyor.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ViewModel'den gelen Tarlalar listesini JS tarafında işleyip grafiğe döküyoruz

        // 1. Veriyi hazırla (Razor ile C# verisini JS dizisine çevir)
        // Burada Lokasyon bazlı gruplama yapıyoruz
        var rawData = @Html.Raw(Json.Serialize(
                    Model.Tarlalar
                            .GroupBy(t => t.Lokasyon != null ? t.Lokasyon.Ad : "Belirsiz")
                            .Select(g => new { Label = g.Key, Count = g.Count() })
            ));

    var labels = rawData.map(x => x.label);
    var dataCounts = rawData.map(x => x.count);

        if (dataCounts && dataCounts.length > 0) {
            const ctx = document.getElementById('bolgeChart');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataCounts,
                        backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#0dcaf0', '#6610f2', '#fd7e14'],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }
    </script>
}