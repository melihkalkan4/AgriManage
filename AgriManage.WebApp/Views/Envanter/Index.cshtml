@model List<AgriManage.WebApp.DTOs.UrunDto>

@{
    ViewData["Title"] = "Envanter Yönetimi";

    // Güvenli Cast İşlemi
    int tarlaId = 0;
    if (ViewBag.SeciliTarlaId != null)
    {
        tarlaId = (int)ViewBag.SeciliTarlaId;
    }

    bool merkezDepoMu = (tarlaId == 0);
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary">
                @if (merkezDepoMu)
                {
                    <i class="fa-solid fa-warehouse me-2"></i>
                
                    <span>Merkez Depo Yönetimi</span>
                }
                else
                {
                    <i class="fa-solid fa-wheat-awn me-2"></i>
                
                    <span>Tarla Envanteri</span>
                }
            </h2>
            <p class="text-muted">
                @(merkezDepoMu ? "Şirketin tüm stok girişi ve satın alma işlemleri buradan yapılır." : "Bu tarladaki ürünleri yönetebilir, kullanabilir veya depoya iade edebilirsiniz.")
            </p>
        </div>

        <div>
            @if (merkezDepoMu)
            {
                // SENARYO A: MERKEZ DEPO (Satın Alma)
                <a asp-action="Create" asp-route-tarlaId="0" class="btn btn-success shadow">
                    <i class="fa-solid fa-cart-plus me-2"></i> Yeni Stok Girişi
                </a>
            }
            else
            {
                // SENARYO B: TARLA (Depodan Mal Çekme)
                <button class="btn btn-warning shadow text-dark fw-bold" onclick="modalAc()">
                    <i class="fa-solid fa-dolly me-2"></i> Depodan Malzeme Getir
                </button>
            }
        </div>
    </div>

    @if (ViewBag.Hata != null)
    {
        <div class="alert alert-danger shadow-sm">
            <i class="fa-solid fa-circle-exclamation me-2"></i>@ViewBag.Hata
        </div>
    }

    <div class="card shadow-sm border-0">
        <div class="card-body p-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th class="ps-4">Ürün Adı</th>
                        <th>Mevcut Stok</th>
                        <th>Birim Fiyat</th>
                        <th>Toplam Değer</th>
                        @if (!merkezDepoMu)
                        {
                            <th class="text-end pe-4" style="min-width: 200px;">Operasyonlar</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td class="ps-4 fw-bold text-dark">@item.Name</td>
                                <td>
                                    <span class="badge bg-info text-dark border border-info bg-opacity-25 fs-6">
                                        @item.StockQuantity Adet/Kg
                                    </span>
                                </td>
                                <td>@item.Price.ToString("C2")</td>
                                <td class="fw-bold text-success">
                                    @((item.StockQuantity * item.Price).ToString("C2"))
                                </td>

                                @if (!merkezDepoMu)
                                {
                                    <td class="text-end pe-4">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-success"
                                                    onclick="tuketimModalAc(@item.Id, '@item.Name', @item.StockQuantity)"
                                                    title="Tarlada Kullan">
                                                <i class="fa-solid fa-check-double me-1"></i> Kullan
                                            </button>

                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="iadeEt(@item.Id, '@item.Name', @item.StockQuantity)"
                                                    title="Merkez Depoya İade Et">
                                                <i class="fa-solid fa-rotate-left"></i> İade
                                            </button>
                                        </div>
                                    </td>
                                }
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <i class="fa-solid fa-box-open fa-3x mb-3 opacity-25"></i><br />
                                @(merkezDepoMu ? "Depo şu an boş." : "Bu tarlada kayıtlı ürün yok.")
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="mt-4">
        @if (!merkezDepoMu)
        {
            <a asp-controller="Tarla" asp-action="Index" class="btn btn-outline-secondary">
                <i class="fa-solid fa-arrow-left me-1"></i> Tarlalara Dön
            </a>
        }
        else
        {
            <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
                <i class="fa-solid fa-house me-1"></i> Ana Sayfa
            </a>
        }
    </div>
</div>

@if (!merkezDepoMu)
{
    <div class="modal fade" id="transferModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title text-dark fw-bold"><i class="fa-solid fa-dolly me-2"></i>Depodan Transfer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light border mb-3 small">
                        Merkez depodaki boşta duran ürünleri bu tarlaya zimmetleyebilirsiniz.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Depodaki Ürün:</label>
                        <select id="depoUrunSelect" class="form-select" onchange="stokBilgisiGuncelle()">
                            <option value="" data-stok="0">Yükleniyor...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Alınacak Miktar:</label>
                        <div class="input-group">
                            <input type="number" id="transferMiktar" class="form-control" value="1" min="1">
                            <span class="input-group-text text-muted" id="stokLimitBilgisi">Max: 0</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-warning text-dark fw-bold" onclick="transferYap()">Onayla ve Aktar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="iadeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-rotate-left me-2"></i>Depoya İade Et</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong><span id="iadeUrunAdi"></span></strong> ürününü merkez depoya geri göndermek üzeresiniz.</p>
                    <input type="hidden" id="iadeUrunId" />

                    <label class="form-label fw-bold">İade Miktarı:</label>
                    <div class="input-group">
                        <input type="number" id="iadeMiktar" class="form-control" value="1" min="1" />
                        <span class="input-group-text">Max: <span id="iadeMaxStok"></span></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                    <button type="button" class="btn btn-danger fw-bold" onclick="iadeyiTamamla()">İadeyi Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="tuketimModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title fw-bold"><i class="fa-solid fa-check-double me-2"></i>Sarfiyat / Kullanım</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-light border border-success mb-3">
                        <strong><span id="tuketimUrunAdi"></span></strong> tarlada kullanıldı olarak işaretlenecek ve stoktan düşülecektir.
                    </div>
                    <input type="hidden" id="tuketimUrunId" />

                    <label class="form-label fw-bold">Kullanılan Miktar:</label>
                    <div class="input-group">
                        <input type="number" id="tuketimMiktar" class="form-control" value="1" min="1" />
                        <span class="input-group-text">Mevcut: <span id="tuketimMaxStok">0</span></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
                    <button type="button" class="btn btn-success fw-bold" onclick="tuketimiTamamla()">Kaydet ve Düş</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // 1. TRANSFER İŞLEMLERİ (PULL)
        // ----------------------------------------------------
        function modalAc() {
            var myModal = new bootstrap.Modal(document.getElementById('transferModal'));
            myModal.show();

            fetch('/Envanter/GetDepoUrunleri')
                .then(res => res.json())
                .then(data => {
                    var select = document.getElementById('depoUrunSelect');
                    select.innerHTML = '<option value="" data-stok="0">-- Seçiniz --</option>';
                    if(data.length === 0) {
                        select.innerHTML = '<option disabled>Depo Boş!</option>'; return;
                    }
                    data.forEach(item => {
                        let fiyat = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY' }).format(item.price);
                        select.innerHTML += `<option value="${item.id}" data-stok="${item.stockQuantity}">${item.name} (Stok: ${item.stockQuantity}) - ${fiyat}</option>`;
                    });
                });
        }

        function stokBilgisiGuncelle() {
            var select = document.getElementById('depoUrunSelect');
            var stok = select.options[select.selectedIndex].getAttribute('data-stok');
            document.getElementById('transferMiktar').max = stok;
            document.getElementById('transferMiktar').value = 1;
            document.getElementById('stokLimitBilgisi').innerText = "Max: " + stok;
        }

        function transferYap() {
            var urunId = document.getElementById('depoUrunSelect').value;
            var miktar = document.getElementById('transferMiktar').value;
            var hedefTarlaId = '@tarlaId';

            if(!urunId || miktar < 1) { alert("Lütfen ürün ve geçerli miktar girin."); return; }
            apiTransfer(urunId, hedefTarlaId, miktar);
        }

        // ----------------------------------------------------
        // 2. İADE İŞLEMLERİ (PUSH)
        // ----------------------------------------------------
        function iadeEt(id, ad, stok) {
            document.getElementById('iadeUrunId').value = id;
            document.getElementById('iadeUrunAdi').innerText = ad;
            document.getElementById('iadeMaxStok').innerText = stok;
            document.getElementById('iadeMiktar').max = stok;
            document.getElementById('iadeMiktar').value = 1;

            var iadeModal = new bootstrap.Modal(document.getElementById('iadeModal'));
            iadeModal.show();
        }

        function iadeyiTamamla() {
            var urunId = document.getElementById('iadeUrunId').value;
            var miktar = document.getElementById('iadeMiktar').value;
            var max = parseInt(document.getElementById('iadeMiktar').max);

            if(miktar > max || miktar < 1) { alert("Geçersiz miktar!"); return; }

            // Hedef Tarla ID = 0 (Merkez Depo)
            apiTransfer(urunId, 0, miktar);
        }

        // ----------------------------------------------------
        // 3. TÜKETİM İŞLEMLERİ (CONSUME)
        // ----------------------------------------------------
        function tuketimModalAc(id, ad, stok) {
            document.getElementById('tuketimUrunId').value = id;
            document.getElementById('tuketimUrunAdi').innerText = ad;
            document.getElementById('tuketimMaxStok').innerText = stok;
            document.getElementById('tuketimMiktar').max = stok;
            document.getElementById('tuketimMiktar').value = 1;

            var modal = new bootstrap.Modal(document.getElementById('tuketimModal'));
            modal.show();
        }

        function tuketimiTamamla() {
            var urunId = document.getElementById('tuketimUrunId').value;
            var miktar = parseInt(document.getElementById('tuketimMiktar').value);
            var max = parseInt(document.getElementById('tuketimMaxStok').innerText);

            if (miktar <= 0 || miktar > max) { alert("Geçersiz miktar!"); return; }

            fetch(`/Envanter/UrunTuket?urunId=${urunId}&miktar=${miktar}`, { method: 'POST' })
            .then(res => {
                if(res.ok) { location.reload(); }
                else { alert("İşlem başarısız! Stok hatası olabilir."); }
            });
        }

        // ----------------------------------------------------
        // ORTAK YARDIMCI
        // ----------------------------------------------------
        function apiTransfer(uId, tId, miktar) {
            fetch(`/Envanter/UrunTransferEt?urunId=${uId}&hedefTarlaId=${tId}&miktar=${miktar}`, { method: 'POST' })
            .then(res => {
                if(res.ok) { location.reload(); }
                else { alert("İşlem başarısız! Yetersiz stok veya sunucu hatası."); }
            });
        }
    </script>
}